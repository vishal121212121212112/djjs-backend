// @title DJJS Event Reporting API
// @version 1.0
// @description API documentation for the DJJS Event Reporting Backend.
// @termsOfService http://swagger.io/terms/

// @contact.name API Support
// @contact.email vaish@gmail.com

// @license.name MIT
// @license.url https://opensource.org/licenses/MIT

// @securityDefinitions.apikey ApiKeyAuth
// @in header
// @name Authorization

// @host localhost:8080
// @BasePath /
package main

import (
	"log"
	"os"
	"strings"
	"time"

	"github.com/followCode/djjs-event-reporting-backend/app/api"
	"github.com/followCode/djjs-event-reporting-backend/app/middleware"
	"github.com/followCode/djjs-event-reporting-backend/app/services"
	"github.com/followCode/djjs-event-reporting-backend/config"
	"github.com/gin-contrib/cors"
	"github.com/joho/godotenv"

	"github.com/gin-gonic/gin"

	swaggerFiles "github.com/swaggo/files"     // swagger embed files
	ginSwagger "github.com/swaggo/gin-swagger" // gin-swagger middleware

	_ "github.com/followCode/djjs-event-reporting-backend/docs" // docs is generated by Swag CLI
)

func main() {
	// Load environment variables
	if err := godotenv.Load(); err != nil {
		log.Println("Warning: .env file not found, using system env variables")
	}

	// 1️⃣ Connect to Postgres
	config.ConnectDB()

	// 2️⃣ Set JWT secret from environment
	jwtSecret := os.Getenv("JWT_SECRET")
	if jwtSecret == "" {
		log.Fatal("JWT_SECRET is missing in .env")
	}
	config.JWTSecret = []byte(jwtSecret)

	// 3️⃣ Initialize S3
	if err := services.InitializeS3(); err != nil {
		log.Printf("Warning: Failed to initialize S3: %v", err)
	} else {
		log.Println("S3 initialized successfully")
	}

	// 4️⃣ Create Gin router
	r := gin.Default()

	// Add timeout middleware (30 seconds)
	r.Use(middleware.TimeoutMiddleware(30 * time.Second))

	// Enable CORS for Angular frontend
	// Get allowed origins from environment, default to localhost for development
	allowedOrigins := os.Getenv("ALLOWED_ORIGINS")
	if allowedOrigins == "" {
		allowedOrigins = "http://localhost:4200,http://localhost:3000"
	}
	
	origins := []string{}
	for _, origin := range strings.Split(allowedOrigins, ",") {
		origins = append(origins, strings.TrimSpace(origin))
	}
	
	r.Use(cors.New(cors.Config{
		AllowOrigins:     origins,
		AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"},
		AllowHeaders:     []string{"Origin", "Content-Type", "Content-Length", "Accept-Encoding", "X-CSRF-Token", "Authorization", "accept", "origin", "Cache-Control", "X-Requested-With"},
		ExposeHeaders:    []string{"Content-Length", "Authorization"},
		AllowCredentials: true,
		MaxAge:           12 * time.Hour,
	}))

	// Swagger documentation route
	r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))

	// 5️⃣ Setup all API routes
	api.SetupRoutes(r)

	// 6️⃣ Protected route example
	r.GET("/protected", middleware.AuthMiddleware(), func(c *gin.Context) {
		userID, _ := c.Get("userID")
		roleID, _ := c.Get("roleID")
		c.JSON(200, gin.H{
			"message": "You are authorized",
			"userID":  userID,
			"roleID":  roleID,
		})
	})

	// 7️⃣ Start server
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
	}

	log.Printf("Server starting on port %s...", port)
	if err := r.Run(":" + port); err != nil {
		log.Fatalf("Failed to run server: %v", err)
	}
}

